<div class="pagamentos-container">
  <!-- Estat√≠sticas Header -->
  <div class="estatisticas-header">
    <div class="stat-card hoje">
      <div class="stat-icon">üí∞</div>
      <div class="stat-info">
        <div class="stat-title">Pagamentos Hoje</div>
        <div class="stat-value">{{ estatisticasPagamentos.pagamentosHoje }}</div>
        <div class="stat-subtitle">{{ formatCurrency(estatisticasPagamentos.valorHoje) }}</div>
      </div>
    </div>

    <div class="stat-card mes">
      <div class="stat-icon">üìä</div>
      <div class="stat-info">
        <div class="stat-title">Pagamentos do M√™s</div>
        <div class="stat-value">{{ estatisticasPagamentos.pagamentosMes }}</div>
        <div class="stat-subtitle">{{ formatCurrency(estatisticasPagamentos.valorMes) }}</div>
      </div>
    </div>

    <div class="stat-card juros">
      <div class="stat-icon">üìà</div>
      <div class="stat-info">
        <div class="stat-title">Renova√ß√µes Recebidas</div>
        <div class="stat-value">{{ formatCurrency(estatisticasPagamentos.jurosRecebidos) }}</div>
        <div class="stat-subtitle">este m√™s</div>
      </div>
    </div>

    <div class="stat-card quitacoes">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <div class="stat-title">Quita√ß√µes</div>
        <div class="stat-value">{{ estatisticasPagamentos.quitacoes }}</div>
        <div class="stat-subtitle">este m√™s</div>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div class="controles">
    <div class="filtros">
      <div class="filtro-grupo">
        <label for="filtroCliente">Cliente</label>
        <select id="filtroCliente" [(ngModel)]="filtroCliente">
          <option value="">Todos os clientes</option>
          <option *ngFor="let cliente of clientes" [value]="cliente.id">{{ cliente.nome }}</option>
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="filtroPeriodo">Per√≠odo</label>
        <select id="filtroPeriodo" [(ngModel)]="filtroPeriodo">
          <option value="">Todos</option>
          <option value="hoje">Hoje</option>
          <option value="semana">Esta semana</option>
          <option value="mes">Este m√™s</option>
        </select>
      </div>
    </div>
    
    <div class="acoes">
      <button class="btn-warning" (click)="limparEmprestimosOrfaos()" title="Limpar empr√©stimos sem cliente v√°lido">
        üßπ Limpar √ìrf√£os
      </button>
    </div>
  </div>

  <!-- Tabela de Empr√©stimos Pendentes de Pagamento -->
  <div class="tabela-container">
    <h3 style="margin-bottom: 20px; color: white;">üìã Todos os Empr√©stimos - Baixa de Pagamentos</h3>
    
    <table class="pagamentos-table" *ngIf="emprestimosAtivos.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Valor Original</th>
          <th>Valor Total (c/ juros)</th>
          <th>Vencimento</th>
          <th>Status/Multa</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let emprestimo of emprestimosAtivos">
          <td>#{{ emprestimo.id }}</td>
          <td>{{ getClienteNome(emprestimo.clienteId, emprestimo) }}</td>
          <td class="valor">{{ formatCurrency(emprestimo.valorOriginal) }}</td>
          <td class="valor" [class.multa]="calcularDiasAtraso(emprestimo) > 0">
            {{ formatCurrency(calcularValorTotalComMulta(emprestimo)) }}
            <small *ngIf="calcularMulta(emprestimo) > 0" class="multa-info">
              (+{{ formatCurrency(calcularMulta(emprestimo)) }} multa)
            </small>
          </td>
          <td [class]="emprestimo.status">
            {{ formatDate(emprestimo.proximoVencimento) }}
          </td>
          <td [class]="emprestimo.status">
            <span *ngIf="emprestimo.status === 'vencido'" class="atraso">
              {{ calcularDiasAtraso(emprestimo) }} dias de atraso
            </span>
            <span *ngIf="emprestimo.status === 'ativo'" class="prazo">
              No prazo
            </span>
            <span *ngIf="emprestimo.status === 'pago'" class="pago-status">
              ‚úÖ Pago
            </span>
          </td>
          <td class="acoes">
            <!-- S√≥ mostrar bot√µes se n√£o estiver pago -->
            <div *ngIf="emprestimo.status !== 'pago'">
              <button class="btn-pagamento juros" (click)="abrirModalPagamento('juros', emprestimo)" title="Renovar empr√©stimo por mais 15 dias">
                ÔøΩ Renovar ({{ formatCurrency(calcularJurosComMulta(emprestimo)) }})
              </button>
              <button class="btn-pagamento total" (click)="abrirModalPagamento('total', emprestimo)" title="Quitar empr√©stimo">
                ‚úÖ Quitar ({{ formatCurrency(calcularValorTotalComMulta(emprestimo)) }})
              </button>
            </div>
            <!-- Se j√° estiver pago, mostrar apenas status -->
            <div *ngIf="emprestimo.status === 'pago'" class="pago-info">
              <span class="badge-pago">üíö Quitado</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="sem-dados" *ngIf="emprestimosAtivos.length === 0">
      <p>üìù Nenhum empr√©stimo encontrado</p>
      <small>Crie um empr√©stimo primeiro na aba "Gest√£o de Empr√©stimos"</small>
    </div>
  </div>

  <!-- Hist√≥rico de Pagamentos -->
  <div class="tabela-container" style="margin-top: 30px;">
    <h3 style="margin-bottom: 20px; color: white;">üìä Hist√≥rico de Pagamentos</h3>
    
    <table class="pagamentos-table" *ngIf="pagamentosFiltrados.length > 0">
      <thead>
        <tr>
          <th>Data</th>
          <th>Cliente</th>
          <th>Empr√©stimo</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th>Forma</th>
          <th>Pr√≥ximo Venc.</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let pagamento of pagamentosFiltrados">
          <td>{{ formatDate(pagamento.dataPagamento) }}</td>
          <td>{{ getClienteNome(pagamento.clienteId) }}</td>
          <td>
            <span *ngIf="getEmprestimo(pagamento.emprestimoId); else emprestimoRemovido">
              #{{ pagamento.emprestimoId }}
            </span>
            <ng-template #emprestimoRemovido>
              <span class="emprestimo-removido" title="Empr√©stimo foi removido">
                #{{ pagamento.emprestimoId }} (removido)
              </span>
            </ng-template>
          </td>
          <td>
            <span class="tipo-badge" [class]="'tipo-' + pagamento.tipoPagamento">
              {{ getTipoPagamentoText(pagamento.tipoPagamento) }}
            </span>
          </td>
          <td class="valor">{{ formatCurrency(pagamento.valor) }}</td>
          <td>{{ getFormaPagamentoText(pagamento.formaPagamento) }}</td>
          <td>
            <span *ngIf="pagamento.proximoVencimento" class="proximo-venc">
              {{ formatDate(pagamento.proximoVencimento) }}
            </span>
            <span *ngIf="!pagamento.proximoVencimento" class="quitado">
              Quitado
            </span>
          </td>
          <td class="acoes">
            <button class="btn-icon view" (click)="abrirModalDetalhes(pagamento)" title="Ver detalhes">
              üëÅÔ∏è
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="sem-dados" *ngIf="pagamentosFiltrados.length === 0">
      <p>üìù Nenhum pagamento registrado ainda</p>
      <small>Registre o primeiro pagamento acima</small>
    </div>
  </div>
</div>

<!-- Modal Registrar Pagamento -->
<div class="modal-overlay" *ngIf="mostrarModalPagamento" (click)="fecharModais()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üí∞ Registrar Pagamento</h3>
      <button class="close" (click)="fecharModais()">&times;</button>
    </div>
    
    <form [formGroup]="pagamentoForm" (ngSubmit)="registrarPagamento()">
      <div class="modal-body">
        <div class="form-group">
          <label for="emprestimoId">Empr√©stimo *</label>
          <select id="emprestimoId" formControlName="emprestimoId" (change)="onEmprestimoChange()" required>
            <option value="">Selecione um empr√©stimo</option>
            <option *ngFor="let emprestimo of emprestimosAtivos" [value]="emprestimo.id">
              #{{ emprestimo.id }} - {{ getClienteNome(emprestimo.clienteId) }} - {{ formatCurrency(emprestimo.valorOriginal) }}
              - Vence: {{ formatDate(emprestimo.proximoVencimento) }}
            </option>
          </select>
          <small *ngIf="emprestimosAtivos.length === 0" style="color: #FFB74D;">
            Nenhum empr√©stimo ativo encontrado. Crie um empr√©stimo primeiro.
          </small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="tipoPagamento">Tipo de Pagamento *</label>
            <select id="tipoPagamento" formControlName="tipoPagamento" (change)="onTipoPagamentoChange()" required>
              <option value="juros">Renovar (15 dias)</option>
              <option value="total">Quita√ß√£o Total</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="valor">Valor *</label>
            <input type="number" id="valor" formControlName="valor" 
                   step="0.01" min="0.01" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="formaPagamento">Forma de Pagamento *</label>
            <select id="formaPagamento" formControlName="formaPagamento" required>
              <option value="dinheiro">Dinheiro</option>
              <option value="pix">PIX</option>
              <option value="transferencia">Transfer√™ncia</option>
              <option value="cartao">Cart√£o</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="numeroTransacao">N¬∫ Transa√ß√£o</label>
            <input type="text" id="numeroTransacao" formControlName="numeroTransacao" 
                   placeholder="ID da transa√ß√£o (opcional)">
          </div>
        </div>

        <div class="form-group">
          <label for="observacoes">Observa√ß√µes</label>
          <textarea id="observacoes" formControlName="observacoes" rows="3"
                    placeholder="Informa√ß√µes adicionais sobre o pagamento"></textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="fecharModais()">
          Cancelar
        </button>
        <button type="submit" class="btn-primary" [disabled]="pagamentoForm.invalid">
          üí∞ Registrar Pagamento
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Detalhes do Pagamento -->
<div class="modal-overlay" *ngIf="mostrarModalDetalhes" (click)="fecharModais()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìÑ Detalhes do Pagamento</h3>
      <button class="close" (click)="fecharModais()">&times;</button>
    </div>
    
    <div class="modal-body" *ngIf="pagamentoSelecionado">
      <div class="detalhes-grid">
        <div class="detalhe-item">
          <label>Data do Pagamento:</label>
          <span>{{ formatDate(pagamentoSelecionado.dataPagamento) }}</span>
        </div>

        <div class="detalhe-item">
          <label>Cliente:</label>
          <span>{{ getClienteNome(pagamentoSelecionado.clienteId) }}</span>
        </div>

        <div class="detalhe-item">
          <label>Empr√©stimo:</label>
          <span>#{{ pagamentoSelecionado.emprestimoId }}</span>
        </div>

        <div class="detalhe-item">
          <label>Tipo de Pagamento:</label>
          <span class="tipo-badge" [class]="'tipo-' + pagamentoSelecionado.tipoPagamento">
            {{ getTipoPagamentoText(pagamentoSelecionado.tipoPagamento) }}
          </span>
        </div>

        <div class="detalhe-item">
          <label>Valor Pago:</label>
          <span class="valor-destaque">{{ formatCurrency(pagamentoSelecionado.valor) }}</span>
        </div>

        <div class="detalhe-item">
          <label>Forma de Pagamento:</label>
          <span>{{ getFormaPagamentoText(pagamentoSelecionado.formaPagamento) }}</span>
        </div>

        <div class="detalhe-item" *ngIf="pagamentoSelecionado.numeroTransacao">
          <label>N¬∫ Transa√ß√£o:</label>
          <span>{{ pagamentoSelecionado.numeroTransacao }}</span>
        </div>

        <div class="detalhe-item" *ngIf="pagamentoSelecionado.proximoVencimento">
          <label>Pr√≥ximo Vencimento:</label>
          <span class="proximo-venc">{{ formatDate(pagamentoSelecionado.proximoVencimento) }}</span>
        </div>

        <div class="detalhe-item full-width" *ngIf="pagamentoSelecionado.observacoes">
          <label>Observa√ß√µes:</label>
          <span>{{ pagamentoSelecionado.observacoes }}</span>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="fecharModais()">
        Fechar
      </button>
    </div>
  </div>
</div>