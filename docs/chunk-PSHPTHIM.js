import{M as l,R as S,a as s,b as n,c as r,i as g,p as d,v as h}from"./chunk-VBXVGDHD.js";var p=class c{GIST_ID="004c3f9e832b7a8ad79fdb6a7e1796d5";GIST_READ_ENDPOINT="/.netlify/functions/gist-read";GIST_WRITE_ENDPOINT="/.netlify/functions/gist-write";LOCAL_STORAGE_KEY="bm-emprestimos-data";SYNC_INTERVAL=3e4;dataSubject=new g(this.getInitialData());data$=this.dataSubject.asObservable();constructor(){this.startAutoSync(),this.loadFromLocal(),this.syncFromRemote()}getInitialData(){return{emprestimos:[],clientes:[],lastUpdated:new Date().toISOString(),version:1}}saveToLocal(e){try{localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("Erro ao salvar dados localmente:",t)}}loadFromLocal(){try{let e=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(e){let t=JSON.parse(e);return this.dataSubject.next(t),t}}catch(e){console.error("Erro ao carregar dados locais:",e)}return this.getInitialData()}syncFromRemote(){return r(this,null,function*(){try{let e=yield fetch(this.GIST_READ_ENDPOINT);if(e.ok){let o=(yield e.json()).content;if(o){let a=JSON.parse(o),i=this.dataSubject.value;(a.version>i.version||new Date(a.lastUpdated)>new Date(i.lastUpdated))&&(this.dataSubject.next(a),this.saveToLocal(a),console.log("Dados sincronizados do servidor (via proxy)"))}}else console.warn("N\xE3o foi poss\xEDvel ler o Gist via proxy:",e.status)}catch(e){console.error("Erro ao sincronizar dados remotos (proxy):",e)}})}syncToRemote(e){return r(this,null,function*(){try{let t=yield fetch(this.GIST_WRITE_ENDPOINT,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({content:JSON.stringify(e,null,2)})});t.ok?console.log("Dados enviados para o servidor com sucesso (via proxy)"):console.error("Erro ao enviar dados para o servidor (proxy):",t.statusText)}catch(t){console.error("Erro ao enviar dados para o servidor (proxy):",t)}})}startAutoSync(){h(this.SYNC_INTERVAL).subscribe(()=>{this.syncFromRemote()})}getCurrentData(){return this.dataSubject.value}addCliente(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{clientes:[...t.clientes,e],lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}updateCliente(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{clientes:t.clientes.map(a=>a.id===e.id?e:a),lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}removeCliente(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{clientes:t.clientes.filter(a=>a.id!==e),lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}addEmprestimo(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{emprestimos:[...t.emprestimos,e],lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}updateEmprestimo(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{emprestimos:t.emprestimos.map(a=>a.id===e.id?e:a),lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}removeEmprestimo(e){return r(this,null,function*(){let t=this.getCurrentData(),o=n(s({},t),{emprestimos:t.emprestimos.filter(a=>a.id!==e),lastUpdated:new Date().toISOString(),version:t.version+1});this.dataSubject.next(o),this.saveToLocal(o),yield this.syncToRemote(o)})}forceSync(){return r(this,null,function*(){yield this.syncFromRemote()})}resetData(){return r(this,null,function*(){let e=this.getInitialData();this.dataSubject.next(e),this.saveToLocal(e),yield this.syncToRemote(e)})}static \u0275fac=function(t){return new(t||c)};static \u0275prov=l({token:c,factory:c.\u0275fac,providedIn:"root"})};var f=class c{constructor(e){this.storageService=e;this.initializeDefaultData()}initializeDefaultData(){return r(this,null,function*(){let e=this.storageService.getCurrentData();if(e.clientes.length===0&&e.emprestimos.length===0){let t=this.getDefaultClientes(),o=this.getDefaultEmprestimos();for(let a of t)yield this.storageService.addCliente(a);for(let a of o)yield this.storageService.addEmprestimo(a)}})}getClientes(){return this.storageService.data$.pipe(d(e=>e.clientes))}getEmprestimos(){return this.storageService.data$.pipe(d(e=>e.emprestimos))}getPagamentos(){return this.storageService.data$.pipe(d(e=>this.generatePagamentosFromEmprestimos(e.emprestimos)))}adicionarCliente(e){return r(this,null,function*(){let t=this.storageService.getCurrentData(),o=Math.max(...t.clientes.map(i=>i.id),0)+1,a=n(s({},e),{id:o,dataCadastro:new Date});return yield this.storageService.addCliente(a),a})}atualizarCliente(e){return r(this,null,function*(){yield this.storageService.updateCliente(e)})}removerCliente(e){return r(this,null,function*(){yield this.storageService.removeCliente(e)})}excluirCliente(e){return r(this,null,function*(){yield this.storageService.removeCliente(e)})}adicionarEmprestimo(e){return r(this,null,function*(){let t=this.storageService.getCurrentData(),o=Math.max(...t.emprestimos.map(i=>i.id),0)+1,a=n(s({},e),{id:o,dataContrato:new Date});return yield this.storageService.addEmprestimo(a),a})}atualizarEmprestimo(e){return r(this,null,function*(){yield this.storageService.updateEmprestimo(e)})}removerEmprestimo(e){return r(this,null,function*(){yield this.storageService.removeEmprestimo(e)})}excluirEmprestimo(e){return r(this,null,function*(){yield this.storageService.removeEmprestimo(e)})}atualizarStatusEmprestimo(e,t){return r(this,null,function*(){let a=this.storageService.getCurrentData().emprestimos.find(i=>i.id===e);a&&(a.status=t,yield this.storageService.updateEmprestimo(a))})}renovarEmprestimoPor15Dias(e,t){return r(this,null,function*(){let a=this.storageService.getCurrentData().emprestimos.find(i=>i.id===e);a&&(a.proximoVencimento=t,yield this.storageService.updateEmprestimo(a))})}limparEmprestimosOrfaos(){return r(this,null,function*(){console.log("Limpeza de empr\xE9stimos \xF3rf\xE3os executada")})}sincronizarNomesClientes(){return r(this,null,function*(){console.log("Sincroniza\xE7\xE3o de nomes de clientes executada")})}sincronizar(){return r(this,null,function*(){yield this.storageService.forceSync()})}generatePagamentosFromEmprestimos(e){let t=[],o=1;return e.forEach(a=>{if(a.status==="ativo")for(let i=0;i<6;i++){let m=new Date(a.proximoVencimento);m.setDate(m.getDate()+i*15);let u=new Date,D=Math.max(0,Math.floor((u.getTime()-m.getTime())/(1e3*60*60*24))),v="pendente";m<u&&D>0&&(v="atrasado"),t.push({id:o++,emprestimoId:a.id,cliente:a.cliente,numeroParcela:i+1,valor:a.valorComJuros/10,dataPagamento:new Date,dataVencimento:m,status:v,diasAtraso:v==="atrasado"?D:void 0})}}),t}getDefaultClientes(){return[{id:1,nome:"Maria Silva Santos",cpf:"123.456.789-01",telefone:"(11) 99999-0001",email:"maria.santos@email.com",endereco:"Rua das Flores, 123 - S\xE3o Paulo, SP",renda:3500,dataCadastro:new Date("2024-01-15"),score:750,status:"ativo"},{id:2,nome:"Jo\xE3o Carlos Oliveira",cpf:"987.654.321-02",telefone:"(11) 99999-0002",email:"joao.oliveira@email.com",endereco:"Av. Paulista, 456 - S\xE3o Paulo, SP",renda:4200,dataCadastro:new Date("2024-02-20"),score:680,status:"ativo"},{id:3,nome:"Ana Paula Costa",cpf:"456.789.123-03",telefone:"(11) 99999-0003",email:"ana.costa@email.com",endereco:"Rua Augusta, 789 - S\xE3o Paulo, SP",renda:2800,dataCadastro:new Date("2024-03-10"),score:620,status:"ativo"}]}getDefaultEmprestimos(){let e=new Date,t=new Date(e);t.setDate(e.getDate()+7);let o=new Date(e);o.setDate(e.getDate()+3);let a=new Date(e);return a.setDate(e.getDate()-2),[{id:1,clienteId:1,cliente:"Maria Silva Santos",valorOriginal:5e3,percentualJuros:15,valorComJuros:5750,dataContrato:new Date("2024-10-01"),proximoVencimento:t,status:"ativo",valorPago:1150,saldoDevedor:4600,ciclosVencidos:2,observacoes:"Cliente pontual, hist\xF3rico excelente"},{id:2,clienteId:2,cliente:"Jo\xE3o Carlos Oliveira",valorOriginal:3e3,percentualJuros:18,valorComJuros:3540,dataContrato:new Date("2024-10-15"),proximoVencimento:o,status:"ativo",valorPago:708,saldoDevedor:2832,ciclosVencidos:2,observacoes:"Primeiro empr\xE9stimo do cliente"},{id:3,clienteId:3,cliente:"Ana Paula Costa",valorOriginal:2e3,percentualJuros:20,valorComJuros:2400,dataContrato:new Date("2024-09-20"),proximoVencimento:a,status:"ativo",valorPago:480,saldoDevedor:1920,ciclosVencidos:2,observacoes:"Aten\xE7\xE3o: pagamento em atraso"}]}static \u0275fac=function(t){return new(t||c)(S(p))};static \u0275prov=l({token:c,factory:c.\u0275fac,providedIn:"root"})};export{f as a};
